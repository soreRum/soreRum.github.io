<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Sleeper Draft Sync + Custom Rankings</title>
<script src="https://cdn.tailwindcss.com"></script>
<script>
// Enable Tailwind dark mode
tailwind.config = { darkMode: 'class' };
(function () {
    const saved = localStorage.getItem('theme');
    const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    const useDark = saved ? saved === 'dark' : prefersDark;
    if (useDark) document.documentElement.classList.add('dark');
})();
</script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body class="bg-slate-50 text-slate-900 dark:bg-slate-950 dark:text-slate-100 transition-colors">
<div class="max-w-6xl mx-auto p-6">
<header class="mb-6 flex items-center gap-3 justify-between">
<div class="flex items-center gap-3">
<div>
<h1 class="text-2xl font-bold">Sleeper Draft Sync + Custom Rankings</h1>
<p class="text-sm text-slate-600 dark:text-slate-400">Upload CSV rankings, paste a Sleeper draft URL or ID, auto-sync every 10s during live drafts.</p>
</div>
</div>
<button id="themeToggle" class="px-4 py-2 rounded-xl bg-slate-200 dark:bg-slate-700 text-slate-900 dark:text-slate-100 text-sm font-semibold">ðŸŒ™ Dark Mode</button>
</header>

<section class="grid md:grid-cols-2 gap-4 mb-6">
<div class="p-4 bg-white dark:bg-slate-800 rounded-2xl shadow">
<h2 class="font-semibold mb-2">1) Upload your rankings (.csv)</h2>
<input id="csvFile" type="file" accept=".csv" class="block w-full text-sm" />
<p class="mt-2 text-xs text-slate-600 dark:text-slate-300">Tip: Include a <span class="font-medium">player name</span> column.</p>
<div id="uploadStatus" class="mt-2 text-sm"></div>
</div>

<div class="p-4 bg-white dark:bg-slate-800 rounded-2xl shadow">
<h2 class="font-semibold mb-2">2) Enter Sleeper draft URL or ID</h2>
<input id="draftInput" type="text" placeholder="e.g., https://sleeper.com/draft/nfl/123456789012345678 or 123456789012345678" class="w-full border rounded-xl px-3 py-2 text-sm dark:bg-slate-700 dark:border-slate-600" />
<div class="mt-3 flex items-center gap-2">
<button id="startBtn" class="px-4 py-2 rounded-xl bg-emerald-600 text-white text-sm font-semibold disabled:opacity-50">Start Sync</button>
<button id="stopBtn" class="px-4 py-2 rounded-xl bg-slate-200 dark:bg-slate-700 text-slate-900 dark:text-slate-100 text-sm font-semibold disabled:opacity-50" disabled>Stop</button>
<span id="syncStatus" class="text-xs text-slate-600 dark:text-slate-300"></span>
</div>
<p class="mt-2 text-xs text-slate-600 dark:text-slate-300">The app polls Sleeper every 10 seconds while active.</p>
</div>
</section>

<section class="p-4 bg-white dark:bg-slate-800 rounded-2xl shadow mb-6">
<div class="flex flex-wrap items-center gap-2">
<label class="text-sm">Filter positions:</label>
<div class="flex gap-2 text-sm">
<button data-pos="ALL" class="pos-btn px-3 py-1 rounded-full bg-slate-200 dark:bg-slate-700 dark:text-slate-100">ALL</button>
<button data-pos="QB" class="pos-btn px-3 py-1 rounded-full">QB</button>
<button data-pos="RB" class="pos-btn px-3 py-1 rounded-full">RB</button>
<button data-pos="WR" class="pos-btn px-3 py-1 rounded-full">WR</button>
<button data-pos="TE" class="pos-btn px-3 py-1 rounded-full">TE</button>
<button data-pos="K" class="pos-btn px-3 py-1 rounded-full">K</button>
<button data-pos="DEF" class="pos-btn px-3 py-1 rounded-full">DEF</button>
</div>
<div class="ml-auto flex items-center gap-2">
<input id="searchInput" type="text" placeholder="Search players..." class="border rounded-xl px-3 py-1 text-sm dark:bg-slate-700 dark:border-slate-600" />
<span class="text-xs text-slate-500 dark:text-slate-300" id="counts"></span>
</div>
</div>
</section>

<section class="grid md:grid-cols-3 gap-4">
<div class="md:col-span-2 p-4 bg-white dark:bg-slate-800 rounded-2xl shadow">
<h3 class="font-semibold mb-2">Best Available (by your rankings)</h3>
<div class="overflow-auto">
<table class="min-w-full text-sm" id="availableTable">
<thead class="sticky top-0 bg-slate-100 dark:bg-slate-700">
<tr>
<th class="text-left p-2">#</th>
<th class="text-left p-2">Player</th>
<th class="text-left p-2">POS</th>
<th class="text-left p-2">ADP</th>
<th class="text-left p-2">Team Offense</th>
<th class="text-left p-2">O-Line Grade</th>
</tr>
</thead>
<tbody id="availableBody"></tbody>
</table>
</div>
</div>

<div class="p-4 bg-white dark:bg-slate-800 rounded-2xl shadow">
<h3 class="font-semibold mb-2">Live Picks</h3>
<ol id="picksList" class="text-sm list-decimal pl-5 space-y-1"></ol>
<h3 class="font-semibold mt-4 mb-2">Your Team</h3>
<div id="teamDisplay" class="text-sm space-y-1">
<div><strong>QB:</strong> <span id="teamQB">-</span></div>
<div><strong>RB1:</strong> <span id="teamRB1">-</span></div>
<div><strong>RB2:</strong> <span id="teamRB2">-</span></div>
<div><strong>WR1:</strong> <span id="teamWR1">-</span></div>
<div><strong>WR2:</strong> <span id="teamWR2">-</span></div>
<div><strong>TE:</strong> <span id="teamTE">-</span></div>
<div><strong>FLEX1:</strong> <span id="teamFLEX1">-</span></div>
<div><strong>FLEX2:</strong> <span id="teamFLEX2">-</span></div>
<div><strong>K:</strong> <span id="teamK">-</span></div>
<div><strong>DEF:</strong> <span id="teamDEF">-</span></div>
<div><strong>BN1:</strong> <span id="teamBN1">-</span></div>
<div><strong>BN2:</strong> <span id="teamBN2">-</span></div>
<div><strong>BN3:</strong> <span id="teamBN3">-</span></div>
<div><strong>BN4:</strong> <span id="teamBN4">-</span></div>
<div><strong>BN5:</strong> <span id="teamBN5">-</span></div>
</div>
</div>
</section>

<footer class="text-xs text-slate-500 dark:text-slate-300 mt-8">
Open-source prototype. Sleeper API Â© their owners. Not affiliated with Sleeper.
</footer>

<script>
// ===== STATE =====
let rawRankings=[], rankings=[], playersById={}, timer=null, currentPosFilter='ALL';
const nameToId = new Map();
const draftedIds = new Set();

// Team slots
const teamSlots = {
  QB:null, RB:[null,null], WR:[null,null], TE:null, FLEX:[null,null], K:null, DEF:null, BN:[null,null,null,null,null]
};

// ===== THEME =====
const themeToggle = document.getElementById('themeToggle');
function setTheme(dark){
  document.documentElement.classList.toggle('dark',dark);
  themeToggle.textContent = dark?'â˜€ï¸ Light Mode':'ðŸŒ™ Dark Mode';
  localStorage.setItem('theme',dark?'dark':'light');
}
themeToggle.addEventListener('click',()=>setTheme(!document.documentElement.classList.contains('dark')));
setTheme(document.documentElement.classList.contains('dark'));

// ===== UTILITIES =====
const sleep = ms => new Promise(r=>setTimeout(r,ms));
function normName(s){
  if(!s) return ''; 
  return String(s).toLowerCase().replace(/\./g,'').replace(/\s+jr$/,'').replace(/\s+sr$/,'').replace(/[^a-z\s'-]/g,'').replace(/\s+/g,' ').trim();
}
function extractDraftId(input){const m=String(input).match(/(\d{10,})/); return m?m[1]:null;}
function setSyncStatus(msg){document.getElementById('syncStatus').textContent=msg||'';}
function setCounts(){const avail=getFilteredAvailable();document.getElementById('counts').textContent=`${avail.length} available / ${rankings.length} total`;}

// ===== CSV HANDLING =====
const uploadStatus=document.getElementById('uploadStatus');
document.getElementById('csvFile').addEventListener('change',e=>{
  const file=e.target.files?.[0]; if(!file) return;
  uploadStatus.textContent='Parsing CSV...';
  Papa.parse(file,{header:true,skipEmptyLines:true,complete:res=>{
    try{
      const rows=res.data;
      if(!rows||!rows.length) throw new Error('No rows found');
      normalizeRankings(rows);
    }catch(err){console.error(err);uploadStatus.textContent='Failed to parse CSV: '+err.message;}
  }});
});

function pickKey(obj,candidates){for(const c of candidates) for(const k of Object.keys(obj)) if(String(k).trim().toLowerCase()===c.trim().toLowerCase()) return k; return null;}
function normalizeRankings(rows){
  rawRankings=rows;
  const sample=rows[0]||{};
  const nameKey=pickKey(sample,['player','name'])||Object.keys(sample)[0];
  const posKey=pickKey(sample,['pos','position']);
  const adpKey=pickKey(sample,['adp','rank','ecr']);
  const teamOffKey=pickKey(sample,['team offense','offense grade','team off','team'])||null;
  const olineKey=pickKey(sample,['o-line grade','oline grade','ol grade','o','ol','offensive line'])||null;
  rankings=rows.map((r,idx)=>{
    return {
      rank:idx+1,
      name:(r[nameKey]??'').toString().trim(),
      pos:posKey?(r[posKey]??'').toString().trim().toUpperCase():'',
      adp:adpKey?(r[adpKey]??'').toString().trim():'',
      teamOffense:teamOffKey?(r[teamOffKey]??'').toString().trim():'',
      olineGrade:olineKey?(r[olineKey]??'').toString().trim():'',
      player_id:null
    };
  }).filter(r=>r.name);
  uploadStatus.innerHTML=`<span class="text-emerald-700 dark:text-emerald-400 font-medium">Loaded ${rankings.length} players.</span>`;
  renderAvailable(); setCounts();
}

// ===== SLEEPER API =====
async function loadPlayersMap(){
  if(Object.keys(playersById).length) return;
  setSyncStatus('Loading Sleeper players map...');
  const res=await fetch('https://api.sleeper.app/v1/players/nfl');
  if(!res.ok) throw new Error('Failed to fetch players map');
  playersById=await res.json();
  nameToId.clear();
  for(const [pid,p] of Object.entries(playersById)){
    const full=p.full_name||( [p.first_name,p.last_name].filter(Boolean).join(' ').trim() );
    const nn=normName(full);
    if(nn) nameToId.set(nn,pid);
  }
  for(const r of rankings){
    const id=nameToId.get(normName(r.name));
    if(id) r.player_id=id;
  }
  setSyncStatus('Players map loaded.');
  renderAvailable(); setCounts();
}

async function fetchPicks(draftId){
  const res=await fetch(`https://api.sleeper.app/v1/draft/${draftId}/picks`,{cache:'no-cache'});
  if(!res.ok) throw new Error('Failed to fetch picks');
  return res.json();
}

function assignSlot(name,pos){
  pos=pos.toUpperCase();
  if(pos==='QB'&&!teamSlots.QB) teamSlots.QB=name;
  else if(pos==='RB'){if(!teamSlots.RB[0]) teamSlots.RB[0]=name; else if(!teamSlots.RB[1]) teamSlots.RB[1]=name; else assignFlex(name,pos);}
  else if(pos==='WR'){if(!teamSlots.WR[0]) teamSlots.WR[0]=name; else if(!teamSlots.WR[1]) teamSlots.WR[1]=name; else assignFlex(name,pos);}
  else if(pos==='TE'&&!teamSlots.TE) teamSlots.TE=name;
  else if(pos==='K'&&!teamSlots.K) teamSlots.K=name;
  else if(pos==='DEF'&&!teamSlots.DEF) teamSlots.DEF=name;
  else assignFlex(name,pos);
}
function assignFlex(name,pos){
  for(let i=0;i<2;i++){if(!teamSlots.FLEX[i]){teamSlots.FLEX[i]=name; return;}}
  for(let i=0;i<5;i++){if(!teamSlots.BN[i]){teamSlots.BN[i]=name; return;}}
}
function renderTeam(){
  document.getElementById('teamQB').textContent=teamSlots.QB||'-';
  document.getElementById('teamRB1').textContent=teamSlots.RB[0]||'-';
  document.getElementById('teamRB2').textContent=teamSlots.RB[1]||'-';
  document.getElementById('teamWR1').textContent=teamSlots.WR[0]||'-';
  document.getElementById('teamWR2').textContent=teamSlots.WR[1]||'-';
  document.getElementById('teamTE').textContent=teamSlots.TE||'-';
  document.getElementById('teamFLEX1').textContent=teamSlots.FLEX[0]||'-';
  document.getElementById('teamFLEX2').textContent=teamSlots.FLEX[1]||'-';
  document.getElementById('teamK').textContent=teamSlots.K||'-';
  document.getElementById('teamDEF').textContent=teamSlots.DEF||'-';
  for(let i=0;i<5;i++) document.getElementById(`teamBN${i+1}`).textContent=teamSlots.BN[i]||'-';
}

async function poll(draftId){
  try{
    await loadPlayersMap();
    const picks=await fetchPicks(draftId);
    draftedIds.clear();
    teamSlots.QB=null; teamSlots.RB.fill(null); teamSlots.WR.fill(null); teamSlots.TE=null;
    teamSlots.FLEX.fill(null); teamSlots.K=null; teamSlots.DEF=null; teamSlots.BN.fill(null);

    const picksList=document.getElementById('picksList');
    picksList.innerHTML='';
    picks.forEach(p=>{
      const pid=p.player_id||(p.metadata&&p.metadata.player_id);
      if(pid) draftedIds.add(String(pid));
      const pl=pid?playersById[String(pid)]||{}:{};
      const fullName=pl.full_name||[pl.first_name,pl.last_name].filter(Boolean).join(' ').trim();
      const who=fullName||(p.metadata?`${p.metadata.first_name||''} ${p.metadata.last_name||''}`.trim():'Unknown');
      const li=document.createElement('li');
      li.textContent=who+(p.metadata&&p.metadata.team?` (${p.metadata.team})`:'');
      picksList.appendChild(li);
      assignSlot(who,pl?.position||p.metadata?.position||'BN');
    });

    renderAvailable(); renderTeam(); setCounts();
    setSyncStatus(`Last updated: ${new Date().toLocaleTimeString()}`);
  }catch(e){console.error(e); setSyncStatus('Sync error: '+e.message);}
}

// ===== RENDERING =====
function getFilteredAvailable(){
  const q=document.getElementById('searchInput').value.trim().toLowerCase();
  return rankings.filter(r=>{
    const notDrafted=!r.player_id||!draftedIds.has(String(r.player_id));
    const posOk=currentPosFilter==='ALL'||(r.pos||'').toUpperCase()===currentPosFilter;
    const qOk=!q||r.name.toLowerCase().includes(q);
    return notDrafted && posOk && qOk;
  });
}
function renderAvailable(){
  const tbody=document.getElementById('availableBody'); tbody.innerHTML='';
  const rows=getFilteredAvailable().slice(0,300);
  for(const r of rows){
    const tr=document.createElement('tr');
    tr.className='border-b last:border-0 hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors';
    tr.innerHTML=`
      <td class="p-2 text-slate-500 dark:text-slate-300">${r.rank}</td>
      <td class="p-2 font-medium">${r.name}</td>
      <td class="p-2">${r.pos||''}</td>
      <td class="p-2">${r.adp||''}</td>
      <td class="p-2">${r.teamOffense||''}</td>
      <td class="p-2">${r.olineGrade||''}</td>
    `;
    tbody.appendChild(tr);
  }
}

// ===== UI EVENTS =====
document.querySelectorAll('.pos-btn').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.pos-btn').forEach(b=>b.classList.remove('bg-slate-900','text-white','bg-slate-200','dark:bg-slate-700','dark:text-slate-100'));
    document.querySelectorAll('.pos-btn').forEach(b=>b.classList.add('bg-slate-200','dark:bg-slate-700','dark:text-slate-100'));
    btn.classList.remove('bg-slate-200','dark:bg-slate-700','dark:text-slate-100');
    btn.classList.add('bg-slate-900','text-white');
    currentPosFilter=btn.dataset.pos; renderAvailable(); setCounts();
  });
});
document.getElementById('searchInput').addEventListener('input',()=>{renderAvailable(); setCounts();});

document.getElementById('startBtn').addEventListener('click',async()=>{
  const draftInput=document.getElementById('draftInput').value.trim();
  const draftId=extractDraftId(draftInput);
  if(!draftId){alert('Please paste a valid Sleeper draft URL or numeric draft ID.'); return;}
  document.getElementById('startBtn').disabled=true;
  document.getElementById('stopBtn').disabled=false;
  setSyncStatus('Starting...');
  await poll(draftId);
  timer=setInterval(()=>poll(draftId),10000);
});
document.getElementById('stopBtn').addEventListener('click',()=>{
  if(timer) clearInterval(timer);
  setSyncStatus('Stopped');
  document.getElementById('startBtn').disabled=false;
  document.getElementById('stopBtn').disabled=true;
  timer=null;
});
</script>
</body>
</html>





